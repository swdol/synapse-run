<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®­ç»ƒæ•°æ®ç®¡ç†ç³»ç»Ÿ - Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F3F4F6;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* ç£¨ç ‚ç»ç’ƒæ•ˆæœ */
        .glass-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        /* çŠ¶æ€æ ‡ç­¾æ ·å¼ */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.125rem 0.625rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge-manual {
            background-color: #EFF6FF;
            color: #3B82F6;
        }
        .badge-excel {
            background-color: #ECFDF5;
            color: #10B981;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* è¡¨æ ¼hoveræ•ˆæœ */
        .table-row-hover:hover {
            background-color: rgba(249, 250, 251, 0.8);
        }
    </style>
</head>
<body class="text-gray-800 antialiased min-h-screen flex flex-col">

    <!-- é¡¶éƒ¨å¯¼èˆªæ : æç®€é£æ ¼ -->
    <header class="glass-header sticky top-0 z-50 border-b border-gray-200 shadow-sm h-16 flex items-center justify-between px-6 lg:px-12">
        <div class="flex items-center gap-3">
            <!-- Logo å›¾æ ‡ -->
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
            </div>
            <div>
                <h1 class="text-lg font-bold text-gray-900 tracking-tight">RunTrack <span class="text-gray-400 font-normal">Manager</span></h1>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <div class="text-xs hidden md:block">
                <span class="text-gray-500">æ•°æ®æº: </span>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    Keep
                </span>
            </div>
            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="User" class="w-8 h-8 rounded-full border border-gray-200 p-0.5 cursor-pointer hover:border-indigo-500 transition-colors">
        </div>
    </header>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <main class="flex-1 px-6 lg:px-12 py-8 max-w-7xl mx-auto w-full">

        <!-- æˆåŠŸ/é”™è¯¯æç¤º -->
        <div id="successAlert" class="hidden mb-6 px-6 py-3 bg-green-50 border border-green-200 text-green-800 rounded-lg shadow-sm">
            <span class="font-medium">âœ… æ“ä½œæˆåŠŸ</span>
        </div>
        <div id="errorAlert" class="hidden mb-6 px-6 py-3 bg-red-50 border border-red-200 text-red-800 rounded-lg shadow-sm">
            <span class="font-medium">âŒ æ“ä½œå¤±è´¥</span>
        </div>

        <!-- é¡¶éƒ¨æ“ä½œæ ï¼šå°†æœç´¢ä¸æ·»åŠ åˆ†å¼€ï¼Œå±‚æ¬¡æ›´åˆ†æ˜ -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h2 class="text-2xl font-bold text-gray-900">è®­ç»ƒè®°å½•</h2>
                <p class="text-sm text-gray-500 mt-1">ç®¡ç†å¹¶ç›‘æ§æ‰€æœ‰ç”¨æˆ·çš„è·‘æ­¥æ•°æ®</p>
            </div>

            <div class="flex items-center gap-3 w-full md:w-auto">
                <!-- æœç´¢æ¡† -->
                <div class="relative group w-full md:w-64">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-4 w-4 text-gray-400 group-focus-within:text-indigo-500 transition-colors" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                    <input type="text" id="searchInput" class="block w-full pl-10 pr-3 py-2 border border-gray-200 rounded-lg leading-5 bg-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition-shadow shadow-sm" placeholder="æœç´¢ ID æˆ–ç±»å‹...">
                </div>

                <!-- åˆ·æ–°æŒ‰é’® -->
                <button onclick="loadRecords()" class="p-2 bg-white border border-gray-200 rounded-lg text-gray-500 hover:text-indigo-600 hover:border-indigo-200 transition-all shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </button>

                <!-- æ·»åŠ æŒ‰é’® (ä¸»è¡ŒåŠ¨ç‚¹) -->
                <button onclick="showAddModal()" class="flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded-lg shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    æ·»åŠ è®°å½•
                </button>
            </div>
        </div>

        <!-- è¡¨æ ¼å¡ç‰‡ -->
        <div class="bg-white rounded-xl shadow-[0_2px_15px_-3px_rgba(0,0,0,0.07),0_10px_20px_-2px_rgba(0,0,0,0.04)] overflow-hidden border border-gray-100">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-100">
                    <thead class="bg-gray-50/50">
                        <tr>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">ID</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">ç”¨æˆ·</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">ç±»å‹</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">å¼€å§‹æ—¶é—´</th>
                            <th scope="col" class="px-6 py-4 text-right text-xs font-semibold text-gray-400 uppercase tracking-wider">æ•°æ®æŒ‡æ ‡</th>
                            <th scope="col" class="px-6 py-4 text-center text-xs font-semibold text-gray-400 uppercase tracking-wider">å¿ƒç‡</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">æ¥æº</th>
                            <th scope="col" class="px-6 py-4 text-right text-xs font-semibold text-gray-400 uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTableBody" class="bg-white divide-y divide-gray-50 text-sm">
                        <tr>
                            <td colspan="8" class="px-6 py-12 text-center text-gray-500">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- åˆ†é¡µ -->
            <div class="px-6 py-4 border-t border-gray-100 flex items-center justify-between">
                <span id="pageInfo" class="text-sm text-gray-500">ç¬¬ 1 é¡µ</span>
                <div class="flex items-center gap-2">
                    <button onclick="previousPage()" class="px-3 py-1 text-sm border border-gray-200 rounded text-gray-500 hover:bg-gray-50 disabled:opacity-50">ä¸Šä¸€é¡µ</button>
                    <button onclick="nextPage()" class="px-3 py-1 text-sm border border-gray-200 rounded text-gray-500 hover:bg-gray-50">ä¸‹ä¸€é¡µ</button>
                </div>
            </div>
        </div>
    </main>

    <!-- æ·»åŠ /ç¼–è¾‘è®°å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="recordModal">
        <div class="modal-content">
            <div class="px-8 py-6 border-b border-gray-100">
                <div class="flex justify-between items-center">
                    <h2 id="modalTitle" class="text-xl font-bold text-gray-900">æ·»åŠ è®­ç»ƒè®°å½•</h2>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors text-2xl">&times;</button>
                </div>
            </div>

            <form id="recordForm" onsubmit="submitRecord(event)" class="px-8 py-6">
                <input type="hidden" id="recordId">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ç”¨æˆ·ID <span class="text-red-500">*</span></label>
                        <input type="text" id="userId" value="default_user" required class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">è¿åŠ¨ç±»å‹ <span class="text-red-500">*</span></label>
                        <select id="exerciseType" required class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all">
                            <option value="">-- è¯·é€‰æ‹© --</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">å¼€å§‹æ—¶é—´ <span class="text-red-500">*</span></label>
                        <input type="datetime-local" id="startTime" required class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ç»“æŸæ—¶é—´ <span class="text-red-500">*</span></label>
                        <input type="datetime-local" id="endTime" required class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">æŒç»­æ—¶é•¿(ç§’) <span class="text-red-500">*</span></label>
                        <input type="number" id="durationSeconds" min="1" required class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">è·ç¦»(ç±³)</label>
                        <input type="number" id="distanceMeters" min="0" step="0.01" class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">æ¶ˆè€—å¡è·¯é‡Œ</label>
                        <input type="number" id="calories" min="0" class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">æ•°æ®æ¥æº</label>
                        <select id="dataSource" class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all">
                            <option value="manual_import">æ‰‹åŠ¨å¯¼å…¥</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">å¹³å‡å¿ƒç‡</label>
                        <input type="number" id="avgHeartRate" min="30" max="220" class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">æœ€å¤§å¿ƒç‡</label>
                        <input type="number" id="maxHeartRate" min="30" max="220" class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all">
                    </div>
                </div>

                <div class="mt-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">å¿ƒç‡æ•°æ® (JSONæ ¼å¼æ•°ç»„,å¯é€‰)</label>
                    <textarea id="heartRateData" rows="4" placeholder='ä¾‹: ["120","125","130","128"]' class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all"></textarea>
                </div>

                <div class="flex gap-3 justify-end mt-8">
                    <button type="button" onclick="closeModal()" class="px-6 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg transition-colors">å–æ¶ˆ</button>
                    <button type="submit" class="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg shadow-md hover:shadow-lg transition-all">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        let editingRecordId = null;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadExerciseTypes();
            loadDataSources();
            loadRecords();
        });

        // åŠ è½½è¿åŠ¨ç±»å‹
        async function loadExerciseTypes() {
            try {
                const response = await fetch('/training/api/exercise_types');
                const result = await response.json();
                if (result.success) {
                    const select = document.getElementById('exerciseType');
                    select.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
                    result.data.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½è¿åŠ¨ç±»å‹å¤±è´¥:', error);
            }
        }

        // åŠ è½½æ•°æ®æ¥æº
        async function loadDataSources() {
            try {
                const response = await fetch('/training/api/data_sources');
                const result = await response.json();
                if (result.success) {
                    const select = document.getElementById('dataSource');
                    select.innerHTML = '';
                    result.data.forEach(source => {
                        const option = document.createElement('option');
                        option.value = source;
                        option.textContent = source;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½æ•°æ®æ¥æºå¤±è´¥:', error);
            }
        }

        // åŠ è½½è®­ç»ƒè®°å½•
        async function loadRecords() {
            try {
                const response = await fetch(`/training/api/records?page=${currentPage}&per_page=20`);
                const result = await response.json();

                if (result.success) {
                    const tbody = document.getElementById('recordsTableBody');
                    tbody.innerHTML = '';

                    if (result.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-12 text-center text-gray-500">æš‚æ— æ•°æ®</td></tr>';
                        return;
                    }

                    result.data.forEach(record => {
                        const row = document.createElement('tr');
                        row.className = 'table-row-hover transition-colors group';

                        // æ ¼å¼åŒ–æ•°æ®
                        const startTime = record.start_time ? record.start_time.replace(' ', ' ') : '-';
                        const distance = record.distance_meters ? (record.distance_meters / 1000).toFixed(2) : '-';
                        const calories = record.calories || '-';
                        const duration = formatDuration(record.duration_seconds);
                        const avgHr = record.avg_heart_rate || '-';
                        const maxHr = record.max_heart_rate || '-';
                        const userInitial = record.user_id.charAt(0).toUpperCase();

                        // æ•°æ®æ¥æºbadgeæ ·å¼
                        const sourceBadge = record.data_source.includes('excel') ? 'badge-excel' : 'badge-manual';
                        const sourceText = record.data_source.includes('excel') ? 'Excel' : 'Manual';

                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-gray-400 font-mono text-xs">#${record.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold text-xs mr-3">${userInitial}</div>
                                    <span class="font-medium text-gray-700">${record.user_id}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="flex items-center gap-1.5 text-gray-700 font-medium">
                                    ğŸƒ ${record.exercise_type}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-500">
                                ${startTime.split(' ')[0]} <span class="text-gray-400 ml-1 text-xs">${startTime.split(' ')[1] || ''}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">
                                <div class="text-gray-900 font-semibold">${distance}${distance !== '-' ? ' <span class="text-gray-400 text-xs font-normal">km</span>' : ''}</div>
                                <div class="text-gray-400 text-xs">${calories}${calories !== '-' ? ' kcal' : ''} Â· ${duration}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                ${avgHr !== '-' ? `<div class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-50 text-red-600">â¤ ${avgHr} / ${maxHr}</div>` : '<span class="text-gray-400">-</span>'}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="badge ${sourceBadge}">${sourceText}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button onclick="editRecord(${record.id})" class="text-gray-400 hover:text-indigo-600 transition-colors mx-1 p-1 rounded hover:bg-indigo-50" title="ç¼–è¾‘">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                    </svg>
                                </button>
                                <button onclick="deleteRecord(${record.id})" class="text-gray-400 hover:text-red-600 transition-colors mx-1 p-1 rounded hover:bg-red-50" title="åˆ é™¤">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });

                    // æ›´æ–°åˆ†é¡µä¿¡æ¯
                    totalPages = Math.ceil(result.total / result.per_page);
                    document.getElementById('pageInfo').textContent = `æ˜¾ç¤º ${(currentPage-1)*result.per_page + 1} åˆ° ${Math.min(currentPage*result.per_page, result.total)} æ¡ï¼Œå…± ${result.total} æ¡è®°å½•`;
                }
            } catch (error) {
                showError('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message);
            }
        }

        // æ ¼å¼åŒ–æ—¶é•¿
        function formatDuration(seconds) {
            if (!seconds) return '-';
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // æ˜¾ç¤ºæ·»åŠ æ¨¡æ€æ¡†
        function showAddModal() {
            editingRecordId = null;
            document.getElementById('modalTitle').textContent = 'æ·»åŠ è®­ç»ƒè®°å½•';
            document.getElementById('recordForm').reset();
            document.getElementById('recordId').value = '';
            document.getElementById('userId').value = 'default_user';
            document.getElementById('recordModal').classList.add('active');
        }

        // ç¼–è¾‘è®°å½•
        async function editRecord(id) {
            try {
                const response = await fetch(`/training/api/record/${id}`);
                const result = await response.json();

                if (result.success) {
                    editingRecordId = id;
                    const record = result.data;

                    document.getElementById('modalTitle').textContent = 'ç¼–è¾‘è®­ç»ƒè®°å½•';
                    document.getElementById('recordId').value = record.id;
                    document.getElementById('userId').value = record.user_id;
                    document.getElementById('exerciseType').value = record.exercise_type;
                    document.getElementById('startTime').value = record.start_time.replace(' ', 'T');
                    document.getElementById('endTime').value = record.end_time.replace(' ', 'T');
                    document.getElementById('durationSeconds').value = record.duration_seconds;
                    document.getElementById('distanceMeters').value = record.distance_meters || '';
                    document.getElementById('calories').value = record.calories || '';
                    document.getElementById('avgHeartRate').value = record.avg_heart_rate || '';
                    document.getElementById('maxHeartRate').value = record.max_heart_rate || '';
                    document.getElementById('heartRateData').value = record.heart_rate_data || '';
                    document.getElementById('dataSource').value = record.data_source;

                    document.getElementById('recordModal').classList.add('active');
                }
            } catch (error) {
                showError('åŠ è½½è®°å½•å¤±è´¥: ' + error.message);
            }
        }

        // æäº¤è®°å½•
        async function submitRecord(event) {
            event.preventDefault();

            const data = {
                user_id: document.getElementById('userId').value,
                exercise_type: document.getElementById('exerciseType').value,
                start_time: document.getElementById('startTime').value.replace('T', ' ') + ':00',
                end_time: document.getElementById('endTime').value.replace('T', ' ') + ':00',
                duration_seconds: document.getElementById('durationSeconds').value,
                distance_meters: document.getElementById('distanceMeters').value || null,
                calories: document.getElementById('calories').value || null,
                avg_heart_rate: document.getElementById('avgHeartRate').value || null,
                max_heart_rate: document.getElementById('maxHeartRate').value || null,
                heart_rate_data: document.getElementById('heartRateData').value || null,
                data_source: document.getElementById('dataSource').value
            };

            try {
                let url = '/training/api/record';
                let method = 'POST';

                if (editingRecordId) {
                    url = `/training/api/record/${editingRecordId}`;
                    method = 'PUT';
                }

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess(result.message);
                    closeModal();
                    loadRecords();
                } else {
                    showError(result.message);
                }
            } catch (error) {
                showError('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤è®°å½•
        async function deleteRecord(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—?')) {
                return;
            }

            try {
                const response = await fetch(`/training/api/record/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess('åˆ é™¤æˆåŠŸ');
                    loadRecords();
                } else {
                    showError(result.message);
                }
            } catch (error) {
                showError('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('recordModal').classList.remove('active');
            editingRecordId = null;
        }

        // æœç´¢è®°å½•
        function searchRecords() {
            const searchText = document.getElementById('searchInput').value;
            alert('æœç´¢åŠŸèƒ½å¾…å®ç°: ' + searchText);
        }

        // ä¸Šä¸€é¡µ
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                loadRecords();
            }
        }

        // ä¸‹ä¸€é¡µ
        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                loadRecords();
            }
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            const alert = document.getElementById('successAlert');
            alert.textContent = 'âœ… ' + message;
            alert.classList.remove('hidden');
            setTimeout(() => {
                alert.classList.add('hidden');
            }, 3000);
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            const alert = document.getElementById('errorAlert');
            alert.textContent = 'âŒ ' + message;
            alert.classList.remove('hidden');
            setTimeout(() => {
                alert.classList.add('hidden');
            }, 5000);
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('recordModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html>
